<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–∫—Ç–∏–≤–∏—Å—Ç—ã –®–∫–æ–ª—ã</title>
<!-- SheetJS for Excel support -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<style>
:root {
--primary: #2563eb;
--primary-dark: #1d4ed8;
--secondary: #f9fafb;
--text: #1f2937;
--text-light: #6b7280;
--border: #e5e7eb;
--success: #10b981;
--warning: #f59e0b;
--danger: #ef4444;
--archive: #6b7280;
--card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body {
background-color: #f3f4f6;
color: var(--text);
line-height: 1.6;
}
.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}
header {
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: white;
padding: 20px 0;
margin-bottom: 30px;
border-radius: 0 0 12px 12px;
box-shadow: var(--card-shadow);
}
.header-content {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0 20px;
}
.logo {
font-size: 24px;
font-weight: bold;
}
.auth-section {
display: flex;
gap: 15px;
align-items: center;
}
.user-info {
display: flex;
align-items: center;
gap: 10px;
}
.logout-btn {
background: rgba(255, 255, 255, 0.2);
border: none;
color: white;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
transition: background 0.2s;
}
.logout-btn:hover {
background: rgba(255, 255, 255, 0.3);
}
.main-content {
display: grid;
grid-template-columns: 1fr 380px;
gap: 30px;
}
@media (max-width: 900px) {
.main-content {
grid-template-columns: 1fr;
}
}
.activists-list {
background: white;
border-radius: 12px;
padding: 25px;
box-shadow: var(--card-shadow);
}
.section-title {
font-size: 22px;
margin-bottom: 20px;
padding-bottom: 10px;
border-bottom: 2px solid var(--border);
color: var(--primary-dark);
display: flex;
justify-content: space-between;
align-items: center;
}
.section-actions {
display: flex;
gap: 10px;
}
.section-actions button {
background: var(--primary);
color: white;
border: none;
padding: 6px 12px;
border-radius: 6px;
font-size: 14px;
cursor: pointer;
}
.filters {
display: flex;
gap: 12px;
margin-bottom: 20px;
flex-wrap: wrap;
}
.filter-group {
flex: 1;
min-width: 150px;
}
.filter-label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: var(--text-light);
font-size: 13px;
}
.filter-input, .filter-select {
width: 100%;
padding: 10px 12px;
border: 1px solid var(--border);
border-radius: 8px;
font-size: 14px;
}
.alphabet-filter {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin-top: 10px;
margin-bottom: 15px;
}
.alphabet-btn {
width: 32px;
height: 32px;
border: 1px solid var(--border);
background: white;
border-radius: 6px;
font-weight: 600;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
}
.alphabet-btn.active {
background: var(--primary);
color: white;
border-color: var(--primary);
}
.activist-card {
background: var(--secondary);
border: 1px solid var(--border);
border-radius: 10px;
padding: 20px;
margin-bottom: 15px;
transition: transform 0.2s, box-shadow 0.2s;
position: relative;
opacity: 1;
}
.activist-card.archived {
opacity: 0.6;
border-left: 4px solid var(--archive);
}
.activist-card:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.1);
}
.action-btn {
background: var(--danger);
color: white;
border: none;
padding: 4px 10px;
border-radius: 20px;
cursor: pointer;
font-size: 12px;
font-weight: 600;
margin-left: 8px;
opacity: 0;
transition: opacity 0.2s;
}
.activist-card:hover .action-btn {
opacity: 1;
}
.edit-btn {
background: var(--warning);
}
.archive-btn {
background: var(--archive);
}
.registration-status {
display: inline-flex;
align-items: center;
gap: 8px;
}
.activist-header {
display: flex;
justify-content: space-between;
margin-bottom: 12px;
align-items: flex-start;
}
.activist-name {
font-size: 18px;
font-weight: 700;
color: var(--primary-dark);
display: flex;
align-items: center;
gap: 10px;
}
.badge {
background: var(--primary);
color: white;
padding: 2px 8px;
border-radius: 12px;
font-size: 12px;
font-weight: 600;
}
.activist-details {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
gap: 12px;
}
.detail-item {
display: flex;
flex-direction: column;
}
.detail-label {
font-size: 12px;
color: var(--text-light);
margin-bottom: 4px;
}
.detail-value {
font-weight: 600;
}
.registered {
background: rgba(16, 185, 129, 0.15);
color: var(--success);
padding: 4px 10px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
}
.not-registered {
background: rgba(239, 68, 68, 0.15);
color: var(--danger);
padding: 4px 10px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
}
.archived-status {
background: rgba(107, 114, 128, 0.15);
color: var(--archive);
padding: 4px 10px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
}
.form-section {
background: white;
border-radius: 12px;
padding: 25px;
box-shadow: var(--card-shadow);
height: fit-content;
}
.form-group {
margin-bottom: 20px;
}
.form-label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: var(--text);
}
.form-input, .form-select, .form-textarea {
width: 100%;
padding: 12px;
border: 1px solid var(--border);
border-radius: 8px;
font-size: 14px;
}
.form-textarea {
min-height: 80px;
resize: vertical;
}
.form-checkbox {
display: flex;
align-items: center;
gap: 10px;
margin-top: 8px;
}
.submit-btn, .import-export-btn {
background: var(--primary);
color: white;
border: none;
padding: 12px 24px;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
width: 100%;
transition: background 0.2s;
margin-top: 10px;
}
.submit-btn:hover, .import-export-btn:hover {
background: var(--primary-dark);
}
.message {
padding: 12px;
border-radius: 8px;
margin-bottom: 20px;
text-align: center;
font-weight: 600;
}
.error {
background: rgba(239, 68, 68, 0.15);
color: var(--danger);
border: 1px solid var(--danger);
}
.success {
background: rgba(16, 185, 129, 0.15);
color: var(--success);
border: 1px solid var(--success);
}
.login-form {
background: white;
border-radius: 12px;
padding: 30px;
box-shadow: var(--card-shadow);
max-width: 400px;
margin: 50px auto;
}
.login-title {
text-align: center;
margin-bottom: 25px;
color: var(--primary-dark);
font-size: 24px;
}
.hidden {
display: none;
}
.empty-state {
text-align: center;
padding: 40px 20px;
color: var(--text-light);
}
.empty-state h3 {
margin-bottom: 10px;
color: var(--text);
}
.excel-drop-area {
border: 2px dashed var(--border);
border-radius: 8px;
padding: 20px;
text-align: center;
margin-top: 15px;
background: var(--secondary);
transition: border-color 0.2s;
}
.excel-drop-area.dragover {
border-color: var(--primary);
background: rgba(37, 99, 235, 0.05);
}
#file-input {
display: none;
}
</style>
</head>
<body>
<div id="app">
<!-- Login Screen -->
<div id="login-screen" class="container">
<div class="login-form">
<h2 class="login-title">–í—Ö–æ–¥ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤</h2>
<div id="login-message" class="message hidden"></div>
<div class="form-group">
<label for="username" class="form-label">–õ–æ–≥–∏–Ω</label>
<select id="username" class="form-select">
<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</option>
<option value="predsedatel">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å —Å–æ–≤–µ—Ç–∞ –æ–±—É—á–∞—é—â–∏—Ö—Å—è</option>
<option value="sovetnik">–°–æ–≤–µ—Ç–Ω–∏–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</option>
<option value="sekretar">–°–µ–∫—Ä–µ—Ç–∞—Ä—å</option>
</select>
</div>
<div class="form-group">
<label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="password" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
</div>
<button id="login-btn" class="submit-btn">–í–æ–π—Ç–∏</button>
</div>
</div>
<!-- Main App -->
<div id="main-app" class="container hidden">
<header>
<div class="header-content">
<div class="logo">–ê–∫—Ç–∏–≤–∏—Å—Ç—ã –®–∫–æ–ª—ã</div>
<div class="auth-section">
<div class="user-info">
<span id="current-user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
</div>
<button id="logout-btn" class="logout-btn">–í—ã–π—Ç–∏</button>
</div>
</div>
</header>
<div class="main-content">
<div class="activists-list">
<div class="section-title">
–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤
<div class="section-actions">
<button id="reset-filters-btn">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
<button id="export-btn">–≠–∫—Å–ø–æ—Ä—Ç Excel</button>
</div>
</div>
<div class="filters">
<div class="filter-group">
<label class="filter-label">–ü–æ–∏—Å–∫</label>
<input type="text" id="search-input" class="filter-input" placeholder="–§–ò–û, –∫–ª–∞—Å—Å, email...">
</div>
<div class="filter-group">
<label class="filter-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
<select id="sort-by" class="filter-select">
<option value="name">–ò–º–µ–Ω–∏</option>
<option value="class">–ö–ª–∞—Å—Å—É</option>
<option value="dateAdded">–î–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">–°—Ç–∞—Ç—É—Å</label>
<select id="status-filter" class="filter-select">
<option value="all">–í—Å–µ</option>
<option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
<option value="archived">–ê—Ä—Ö–∏–≤</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">–ì–æ–¥ –æ–±—É—á–µ–Ω–∏—è</label>
<select id="grade-filter" class="filter-select">
<option value="all">–í—Å–µ</option>
<option value="5-7">5‚Äì7 –∫–ª–∞—Å—Å—ã</option>
<option value="8-9">8‚Äì9 –∫–ª–∞—Å—Å—ã</option>
<option value="10-11">10‚Äì11 –∫–ª–∞—Å—Å—ã</option>
</select>
</div>
</div>
<div class="alphabet-filter" id="alphabet-filter">
<!-- Generated by JS -->
</div>
<div id="activists-container">
<!-- Activists will be rendered here -->
</div>
</div>
<div class="form-section">
<h2 class="section-title" id="form-title">–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞</h2>
<div id="form-message" class="message hidden"></div>
<form id="activist-form">
<input type="hidden" id="edit-id">
<div class="form-group">
<label for="first-name" class="form-label">–ò–º—è *</label>
<input type="text" id="first-name" class="form-input" required>
</div>
<div class="form-group">
<label for="last-name" class="form-label">–§–∞–º–∏–ª–∏—è *</label>
<input type="text" id="last-name" class="form-input" required>
</div>
<div class="form-group">
<label for="middle-name" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
<input type="text" id="middle-name" class="form-input">
</div>
<div class="form-group">
<label for="class" class="form-label">–ö–ª–∞—Å—Å *</label>
<select id="class" class="form-select" required>
<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
<!-- 5 –∫–ª–∞—Å—Å—ã -->
<option value="5–ê">5–ê</option>
<option value="5–ë">5–ë</option>
<option value="5–í">5–í</option>
<option value="5–ì">5–ì</option>
<option value="5–î">5–î</option>
<option value="5–ï">5–ï</option>
<option value="5–ú">5–ú</option>
<!-- 6 –∫–ª–∞—Å—Å—ã -->
<option value="6–ê">6–ê</option>
<option value="6–ë">6–ë</option>
<option value="6–í">6–í</option>
<option value="6–ì">6–ì</option>
<option value="6–î">6–î</option>
<option value="6–ï">6–ï</option>
<!-- 7 –∫–ª–∞—Å—Å—ã -->
<option value="7–ê">7–ê</option>
<option value="7–ë">7–ë</option>
<option value="7–í">7–í</option>
<option value="7–ì">7–ì</option>
<option value="7–î">7–î</option>
<option value="7–ï">7–ï</option>
<!-- 8 –∫–ª–∞—Å—Å—ã -->
<option value="8–ê">8–ê</option>
<option value="8–ë">8–ë</option>
<option value="8–í">8–í</option>
<option value="8–ì">8–ì</option>
<option value="8–î">8–î</option>
<option value="8–ï">8–ï</option>
<!-- 9 –∫–ª–∞—Å—Å—ã -->
<option value="9–ê">9–ê</option>
<option value="9–ë">9–ë</option>
<option value="9–í">9–í</option>
<option value="9–ì">9–ì</option>
<option value="9–î">9–î</option>
<option value="9–ï">9–ï</option>
<!-- 10 –∫–ª–∞—Å—Å—ã -->
<option value="10–ê">10–ê</option>
<option value="10–ë">10–ë</option>
<!-- 11 –∫–ª–∞—Å—Å—ã -->
<option value="11–ê">11–ê</option>
<option value="11–ë">11–ë</option>
</select>
</div>
<div class="form-group">
<label for="role" class="form-label">–†–æ–ª—å / –î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
<input type="text" id="role" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –°–û">
</div>
<div class="form-group">
<label for="curator" class="form-label">–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</label>
<input type="text" id="curator" class="form-input">
</div>
<div class="form-group">
<label for="phone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
<input type="tel" id="phone" class="form-input" required>
</div>
<div class="form-group">
<label for="email" class="form-label">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ *</label>
<input type="email" id="email" class="form-input" required>
</div>
<div class="form-group">
<label class="form-label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –î–≤–∏–∂–µ–Ω–∏–∏ –ü–µ—Ä–≤—ã—Ö</label>
<div class="form-checkbox">
<input type="checkbox" id="registered">
<label for="registered">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω(–∞) –Ω–∞ —Å–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–µ—Ä–≤—ã—Ö</label>
</div>
</div>
<button type="submit" class="submit-btn" id="form-submit-btn">–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞</button>
</form>
<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
<h3 style="margin-bottom: 15px; font-size: 18px;">–ò–º–ø–æ—Ä—Ç –∏–∑ Excel</h3>
<div class="excel-drop-area" id="drop-area">
<p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª Excel (.xlsx) —Å—é–¥–∞<br>–∏–ª–∏</p>
<button type="button" class="import-export-btn" id="browse-btn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
<input type="file" id="file-input" accept=".xlsx, .xls">
</div>
<p style="font-size: 12px; color: var(--text-light); margin-top: 10px;">
–û–∂–∏–¥–∞–µ–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã: –§–∞–º–∏–ª–∏—è, –ò–º—è, –û—Ç—á–µ—Å—Ç–≤–æ, –ö–ª–∞—Å—Å, –¢–µ–ª–µ—Ñ–æ–Ω, Email, –†–æ–ª—å, –ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å, –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
</p>
</div>
</div>
</div>
</div>
<script>
// Data model
let activists = [];

// üîê –•—ç—à–∏ –ø–∞—Ä–æ–ª–µ–π (MD5, –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
// –î–ª—è –±–æ–ª—å—à–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ SHA-256 (—Å–º. —Ñ—É–Ω–∫—Ü–∏—é hashPassword –Ω–∏–∂–µ)
const editorAccounts = {
    predsedatel: { 
        passwordHash: "be1b0f6164ef9cdab0e02fb2da01d1c9", // MD5 –æ—Ç "chairman"
        name: "–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å —Å–æ–≤–µ—Ç–∞ –æ–±—É—á–∞—é—â–∏—Ö—Å—è" 
    },
    sovetnik: { 
        passwordHash: "04cb10dfb1848fba4b220047fd72dead", // MD5 –æ—Ç "advisor"
        name: "–°–æ–≤–µ—Ç–Ω–∏–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞" 
    },
    sekretar: { 
        passwordHash: "d422cdf915fc6706f538c752ae9a083f", // MD5 –æ—Ç "secretary"
        name: "–°–µ–∫—Ä–µ—Ç–∞—Ä—å" 
    }
};

let currentUser = null;

// DOM Elements
const loginScreen = document.getElementById('login-screen');
const mainApp = document.getElementById('main-app');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const usernameSelect = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginMessage = document.getElementById('login-message');
const currentUserSpan = document.getElementById('current-user');
const activistForm = document.getElementById('activist-form');
const formMessage = document.getElementById('form-message');
const searchInput = document.getElementById('search-input');
const sortBySelect = document.getElementById('sort-by');
const statusFilter = document.getElementById('status-filter');
const gradeFilter = document.getElementById('grade-filter');
const activistsContainer = document.getElementById('activists-container');
const exportBtn = document.getElementById('export-btn');
const formTitle = document.getElementById('form-title');
const formSubmitBtn = document.getElementById('form-submit-btn');
const editIdInput = document.getElementById('edit-id');
const alphabetFilter = document.getElementById('alphabet-filter');
const resetFiltersBtn = document.getElementById('reset-filters-btn');
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const browseBtn = document.getElementById('browse-btn');

// Initialize IndexedDB
const DB_NAME = 'SchoolActivistsDB';
const STORE_NAME = 'activists';
let db;

function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve();
        };
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                store.createIndex('lastName', 'lastName', { unique: false });
            }
        };
    });
}

async function loadFromDB() {
    try {
        await initDB();
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();
        return new Promise((resolve, reject) => {
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    } catch (err) {
        console.warn('IndexedDB not available, using localStorage fallback');
        const data = localStorage.getItem('activists');
        return data ? JSON.parse(data) : [];
    }
}

async function saveToDB(data) {
    try {
        if (db) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            data.forEach(item => store.put(item));
        } else {
            localStorage.setItem('activists', JSON.stringify(data));
        }
    } catch (err) {
        console.warn('Failed to save to DB, using localStorage');
        localStorage.setItem('activists', JSON.stringify(data));
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get grade range
function getGradeRange(className) {
    if (!className) return null;
    const num = parseInt(className);
    if (num >= 5 && num <= 7) return '5-7';
    if (num >= 8 && num <= 9) return '8-9';
    if (num >= 10 && num <= 11) return '10-11';
    return null;
}

// Format date
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU');
}

// Export to Excel
function exportToExcel() {
    if (activists.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const wsData = [
        ['–§–∞–º–∏–ª–∏—è', '–ò–º—è', '–û—Ç—á–µ—Å—Ç–≤–æ', '–ö–ª–∞—Å—Å', '–¢–µ–ª–µ—Ñ–æ–Ω', 'Email', '–†–æ–ª—å', '–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è']
    ];

    activists.forEach(a => {
        wsData.push([
            a.lastName,
            a.firstName,
            a.middleName || '',
            a.class,
            a.phone,
            a.email,
            a.role || '',
            a.curator || '',
            a.registered ? '–î–∞' : '–ù–µ—Ç',
            a.archived ? '–ê—Ä—Ö–∏–≤' : '–ê–∫—Ç–∏–≤–µ–Ω',
            formatDate(a.dateAdded)
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–ê–∫—Ç–∏–≤–∏—Å—Ç—ã');

    const colWidths = wsData[0].map((_, i) => {
        const maxWidth = Math.max(
            10,
            ...wsData.map(row => (row[i] ? row[i].toString().length : 0))
        );
        return { wch: Math.min(maxWidth + 2, 30) };
    });
    ws['!cols'] = colWidths;

    XLSX.writeFile(wb, `–∞–∫—Ç–∏–≤–∏—Å—Ç—ã_—à–∫–æ–ª—ã_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// Parse Excel file
function parseExcelFile(data) {
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

    if (jsonData.length < 2) return [];

    const headers = jsonData[0].map(h => h.toString().trim());
    const result = [];

    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (!row || row.length === 0) continue;

        const obj = {};
        for (let j = 0; j < headers.length && j < row.length; j++) {
            obj[headers[j]] = row[j] != null ? row[j].toString().trim() : '';
        }

        if (!obj['–§–∞–º–∏–ª–∏—è'] || !obj['–ò–º—è'] || !obj['–ö–ª–∞—Å—Å'] || !obj['–¢–µ–ª–µ—Ñ–æ–Ω'] || !obj['Email']) {
            continue;
        }

        result.push({
            id: Date.now() + Math.random(),
            lastName: obj['–§–∞–º–∏–ª–∏—è'] || '',
            firstName: obj['–ò–º—è'] || '',
            middleName: obj['–û—Ç—á–µ—Å—Ç–≤–æ'] || '',
            class: obj['–ö–ª–∞—Å—Å'] || '',
            phone: obj['–¢–µ–ª–µ—Ñ–æ–Ω'] || '',
            email: obj['Email'] || '',
            role: obj['–†–æ–ª—å'] || '',
            curator: obj['–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'] || '',
            registered: obj['–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'] === '–î–∞',
            archived: obj['–°—Ç–∞—Ç—É—Å'] === '–ê—Ä—Ö–∏–≤',
            dateAdded: new Date().toISOString()
        });
    }

    return result;
}

// Handle file import
function handleFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const newActivists = parseExcelFile(data);
            if (newActivists.length === 0) {
                showFormMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –Ω–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π', 'error');
                return;
            }
            activists.push(...newActivists);
            saveDataAndRender();
            showFormMessage(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${newActivists.length} –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤`, 'success');
        } catch (err) {
            console.error(err);
            showFormMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ Excel', 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// ‚úÖ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
function restoreSession() {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const user = JSON.parse(savedUser);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–∫–æ–π –∞–∫–∫–∞—É–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (editorAccounts[user.username]) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                currentUserSpan.textContent = user.name;
                return true;
            }
        } catch (e) {
            console.warn('Invalid session data');
        }
    }
    return false;
}

// Initialize the app
async function init() {
    // Load data
    activists = await loadFromDB();

    // Event listeners
    loginBtn.addEventListener('click', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    activistForm.addEventListener('submit', handleFormSubmit);
    searchInput.addEventListener('input', renderActivists);
    sortBySelect.addEventListener('change', renderActivists);
    statusFilter.addEventListener('change', renderActivists);
    gradeFilter.addEventListener('change', renderActivists);
    exportBtn.addEventListener('click', exportToExcel);
    resetFiltersBtn.addEventListener('click', resetFilters);
    browseBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    // Drag and drop
    dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('dragover');
    });
    dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('dragover');
    });
    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('dragover');
        if (e.dataTransfer.files[0]) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    // üîë –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    const sessionRestored = restoreSession();

    // Load saved filters (only if session active)
    if (sessionRestored) {
        const savedFilters = JSON.parse(localStorage.getItem('activistFilters') || '{}');
        if (savedFilters.search) searchInput.value = savedFilters.search;
        if (savedFilters.sortBy) sortBySelect.value = savedFilters.sortBy;
        if (savedFilters.status) statusFilter.value = savedFilters.status;
        if (savedFilters.grade) gradeFilter.value = savedFilters.grade;
        renderAlphabetFilter();
        renderActivists();
    } else {
        // Show login screen
        loginScreen.classList.remove('hidden');
        mainApp.classList.add('hidden');
        renderAlphabetFilter();
    }
}

function renderAlphabetFilter() {
    const letters = '–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–≠–Æ–Ø';
    alphabetFilter.innerHTML = letters.split('').map(letter => 
        `<button class="alphabet-btn" data-letter="${letter}">${letter}</button>`
    ).join('');
    alphabetFilter.querySelectorAll('.alphabet-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            alphabetFilter.querySelectorAll('.alphabet-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderActivists();
        });
    });
}

function getActiveLetter() {
    const active = alphabetFilter.querySelector('.alphabet-btn.active');
    return active ? active.dataset.letter : null;
}

function resetFilters() {
    searchInput.value = '';
    sortBySelect.value = 'name';
    statusFilter.value = 'all';
    gradeFilter.value = 'all';
    alphabetFilter.querySelectorAll('.alphabet-btn').forEach(b => b.classList.remove('active'));
    localStorage.removeItem('activistFilters');
    renderActivists();
}

// üîê –§—É–Ω–∫—Ü–∏—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è (MD5 –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º)
// –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SHA-256, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ MD5 –Ω–∏–∂–µ
/*
async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
*/

// MD5 —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –≤–∞—à–∏–º –∏—Å—Ö–æ–¥–Ω—ã–º —Ñ–∞–π–ª–æ–º)
function md5(string) {
    function md5_RotateLeft(lValue, iShiftBits) {
        return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits));
    }
    function md5_AddUnsigned(lX, lY) {
        var lX4, lY4, lX8, lY8, lResult;
        lX8 = (lX & 0x80000000);
        lY8 = (lY & 0x80000000);
        lX4 = (lX & 0x40000000);
        lY4 = (lY & 0x40000000);
        lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
        if (lX4 & lY4) {
            return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
        }
        if (lX4 | lY4) {
            if (lResult & 0x40000000) {
                return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
            } else {
                return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
            }
        } else {
            return (lResult ^ lX8 ^ lY8);
        }
    }
    function md5_F(x, y, z) { return (x & y) | ((~x) & z); }
    function md5_G(x, y, z) { return (x & z) | (y & (~z)); }
    function md5_H(x, y, z) { return (x ^ y ^ z); }
    function md5_I(x, y, z) { return (y ^ (x | (~z))); }
    function md5_FF(a, b, c, d, x, s, ac) {
        a = md5_AddUnsigned(a, md5_AddUnsigned(md5_AddUnsigned(md5_F(b, c, d), x), ac));
        return md5_AddUnsigned(md5_RotateLeft(a, s), b);
    };
    function md5_GG(a, b, c, d, x, s, ac) {
        a = md5_AddUnsigned(a, md5_AddUnsigned(md5_AddUnsigned(md5_G(b, c, d), x), ac));
        return md5_AddUnsigned(md5_RotateLeft(a, s), b);
    };
    function md5_HH(a, b, c, d, x, s, ac) {
        a = md5_AddUnsigned(a, md5_AddUnsigned(md5_AddUnsigned(md5_H(b, c, d), x), ac));
        return md5_AddUnsigned(md5_RotateLeft(a, s), b);
    };
    function md5_II(a, b, c, d, x, s, ac) {
        a = md5_AddUnsigned(a, md5_AddUnsigned(md5_AddUnsigned(md5_I(b, c, d), x), ac));
        return md5_AddUnsigned(md5_RotateLeft(a, s), b);
    };
    function md5_ConvertToWordArray(string) {
        var lWordCount;
        var lMessageLength = string.length;
        var lNumberOfWords_temp1 = lMessageLength + 8;
        var lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
        var lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
        var lWordArray = Array(lNumberOfWords - 1);
        var lBytePosition = 0;
        var lByteCount = 0;
        while (lByteCount < lMessageLength) {
            lWordCount = (lByteCount - (lByteCount % 4)) / 4;
            lBytePosition = (lByteCount % 4) * 8;
            lWordArray[lWordCount] = (lWordArray[lWordCount] | (string.charCodeAt(lByteCount) << lBytePosition));
            lByteCount++;
        }
        lWordCount = (lByteCount - (lByteCount % 4)) / 4;
        lBytePosition = (lByteCount % 4) * 8;
        lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
        lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
        lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
        return lWordArray;
    };
    function md5_WordToHex(lValue) {
        var WordToHexValue = "", WordToHexValue_temp = "", lByte, lCount;
        for (lCount = 0; lCount <= 3; lCount++) {
            lByte = (lValue >>> (lCount * 8)) & 255;
            WordToHexValue_temp = "0" + lByte.toString(16);
            WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length - 2, 2);
        }
        return WordToHexValue;
    };
    function md5_Utf8Encode(string) {
        string = string.replace(/\r\n/g, "\n");
        var utftext = "";
        for (var n = 0; n < string.length; n++) {
            var c = string.charCodeAt(n);
            if (c < 128) {
                utftext += String.fromCharCode(c);
            } else if ((c > 127) && (c < 2048)) {
                utftext += String.fromCharCode((c >> 6) | 192);
                utftext += String.fromCharCode((c & 63) | 128);
            } else {
                utftext += String.fromCharCode((c >> 12) | 224);
                utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                utftext += String.fromCharCode((c & 63) | 128);
            }
        }
        return utftext;
    };
    var x = [];
    var k, AA, BB, CC, DD, a, b, c, d;
    var S11 = 7, S12 = 12, S13 = 17, S14 = 22;
    var S21 = 5, S22 = 9, S23 = 14, S24 = 20;
    var S31 = 4, S32 = 11, S33 = 16, S34 = 23;
    var S41 = 6, S42 = 10, S43 = 15, S44 = 21;
    string = md5_Utf8Encode(string);
    x = md5_ConvertToWordArray(string);
    a = 0x67452301; b = 0xEFCDAB89; c = 0x98BADCFE; d = 0x10325476;
    for (k = 0; k < x.length; k += 16) {
        AA = a; BB = b; CC = c; DD = d;
        a = md5_FF(a, b, c, d, x[k + 0], S11, 0xD76AA478);
        d = md5_FF(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
        c = md5_FF(c, d, a, b, x[k + 2], S13, 0x242070DB);
        b = md5_FF(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
        a = md5_FF(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
        d = md5_FF(d, a, b, c, x[k + 5], S12, 0x4787C62A);
        c = md5_FF(c, d, a, b, x[k + 6], S13, 0xA8304613);
        b = md5_FF(b, c, d, a, x[k + 7], S14, 0xFD469501);
        a = md5_FF(a, b, c, d, x[k + 8], S11, 0x698098D8);
        d = md5_FF(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
        c = md5_FF(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
        b = md5_FF(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
        a = md5_FF(a, b, c, d, x[k + 12], S11, 0x6B901122);
        d = md5_FF(d, a, b, c, x[k + 13], S12, 0xFD987193);
        c = md5_FF(c, d, a, b, x[k + 14], S13, 0xA679438E);
        b = md5_FF(b, c, d, a, x[k + 15], S14, 0x49B40821);
        a = md5_GG(a, b, c, d, x[k + 1], S21, 0xF61E2562);
        d = md5_GG(d, a, b, c, x[k + 6], S22, 0xC040B340);
        c = md5_GG(c, d, a, b, x[k + 11], S23, 0x265E5A51);
        b = md5_GG(b, c, d, a, x[k + 0], S24, 0xE9B6C7AA);
        a = md5_GG(a, b, c, d, x[k + 5], S21, 0xD62F105D);
        d = md5_GG(d, a, b, c, x[k + 10], S22, 0x2441453);
        c = md5_GG(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
        b = md5_GG(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
        a = md5_GG(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
        d = md5_GG(d, a, b, c, x[k + 14], S22, 0xC33707D6);
        c = md5_GG(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
        b = md5_GG(b, c, d, a, x[k + 8], S24, 0x455A14ED);
        a = md5_GG(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
        d = md5_GG(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
        c = md5_GG(c, d, a, b, x[k + 7], S23, 0x676F02D9);
        b = md5_GG(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);
        a = md5_HH(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
        d = md5_HH(d, a, b, c, x[k + 8], S32, 0x8771F681);
        c = md5_HH(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
        b = md5_HH(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
        a = md5_HH(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
        d = md5_HH(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
        c = md5_HH(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
        b = md5_HH(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
        a = md5_HH(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
        d = md5_HH(d, a, b, c, x[k + 0], S32, 0xEAA127FA);
        c = md5_HH(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
        b = md5_HH(b, c, d, a, x[k + 6], S34, 0x4881D05);
        a = md5_HH(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
        d = md5_HH(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
        c = md5_HH(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
        b = md5_HH(b, c, d, a, x[k + 2], S34, 0xC4AC5665);
        a = md5_II(a, b, c, d, x[k + 0], S41, 0xF4292244);
        d = md5_II(d, a, b, c, x[k + 7], S42, 0x432AFF97);
        c = md5_II(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
        b = md5_II(b, c, d, a, x[k + 5], S44, 0xFC93A039);
        a = md5_II(a, b, c, d, x[k + 12], S41, 0x655B59C3);
        d = md5_II(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
        c = md5_II(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
        b = md5_II(b, c, d, a, x[k + 1], S44, 0x85845DD1);
        a = md5_II(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
        d = md5_II(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
        c = md5_II(c, d, a, b, x[k + 6], S43, 0xA3014314);
        b = md5_II(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
        a = md5_II(a, b, c, d, x[k + 4], S41, 0xF7537E82);
        d = md5_II(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
        c = md5_II(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
        b = md5_II(b, c, d, a, x[k + 9], S44, 0xEB86D391);
        a = md5_AddUnsigned(a, AA);
        b = md5_AddUnsigned(b, BB);
        c = md5_AddUnsigned(c, CC);
        d = md5_AddUnsigned(d, DD);
    }
    return (md5_WordToHex(a) + md5_WordToHex(b) + md5_WordToHex(c) + md5_WordToHex(d)).toLowerCase();
}

// Handle login
async function handleLogin(e) {
    e.preventDefault();
    const username = usernameSelect.value;
    const password = passwordInput.value;
    
    if (!username || !password) {
        showLoginMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    if (editorAccounts[username]) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º MD5 –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ö—ç—à–∞–º–∏ –≤ editorAccounts
        const inputHash = md5(password);
        if (inputHash === editorAccounts[username].passwordHash) {
            currentUser = {
                username: username,
                name: editorAccounts[username].name
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            currentUserSpan.textContent = currentUser.name;
            passwordInput.value = '';
            renderActivists();
            return;
        }
    }
    showLoginMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
}

// Handle logout
function handleLogout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    localStorage.removeItem('activistFilters');
    mainApp.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    usernameSelect.value = '';
    passwordInput.value = '';
    loginMessage.classList.add('hidden');
}

function showLoginMessage(message, type) {
    loginMessage.textContent = message;
    loginMessage.className = `message ${type}`;
    loginMessage.classList.remove('hidden');
    setTimeout(() => loginMessage.classList.add('hidden'), 3000);
}

function showFormMessage(message, type) {
    formMessage.textContent = message;
    formMessage.className = `message ${type}`;
    formMessage.classList.remove('hidden');
    setTimeout(() => formMessage.classList.add('hidden'), 3000);
}

// Handle form submission
function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = {
        firstName: document.getElementById('first-name').value.trim(),
        lastName: document.getElementById('last-name').value.trim(),
        middleName: document.getElementById('middle-name').value.trim(),
        class: document.getElementById('class').value,
        role: document.getElementById('role').value.trim(),
        curator: document.getElementById('curator').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        registered: document.getElementById('registered').checked
    };
    
    if (!formData.firstName || !formData.lastName || !formData.class || !formData.phone || !formData.email) {
        showFormMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
        return;
    }
    
    const editId = editIdInput.value;
    if (editId) {
        const index = activists.findIndex(a => a.id == editId);
        if (index !== -1) {
            activists[index] = { ...activists[index], ...formData };
        }
        editIdInput.value = '';
        formTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞';
        formSubmitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞';
    } else {
        const newActivist = {
            id: Date.now(),
            ...formData,
            archived: false,
            dateAdded: new Date().toISOString()
        };
        activists.push(newActivist);
    }
    
    saveDataAndRender();
    activistForm.reset();
    showFormMessage(editId ? '–ê–∫—Ç–∏–≤–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!' : '–ê–∫—Ç–∏–≤–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
}

// Archive activist (no confirmation)
function archiveActivist(activistId) {
    const activist = activists.find(a => a.id === activistId);
    if (activist) {
        activist.archived = true;
        saveDataAndRender();
        showFormMessage('–ê–∫—Ç–∏–≤–∏—Å—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –∞—Ä—Ö–∏–≤', 'success');
    }
}

// Edit activist
function editActivist(activistId) {
    const activist = activists.find(a => a.id === activistId);
    if (!activist) return;
    document.getElementById('first-name').value = activist.firstName;
    document.getElementById('last-name').value = activist.lastName;
    document.getElementById('middle-name').value = activist.middleName || '';
    document.getElementById('class').value = activist.class;
    document.getElementById('role').value = activist.role || '';
    document.getElementById('curator').value = activist.curator || '';
    document.getElementById('phone').value = activist.phone;
    document.getElementById('email').value = activist.email;
    document.getElementById('registered').checked = activist.registered;
    editIdInput.value = activist.id;
    formTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞';
    formSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
    window.scrollTo(0, 0);
}

// Delete activist permanently (only from archive, no confirmation)
function deleteActivist(activistId) {
    activists = activists.filter(a => a.id !== +activistId);
    saveDataAndRender();
    showFormMessage('–ê–∫—Ç–∏–≤–∏—Å—Ç —É–¥–∞–ª—ë–Ω –Ω–∞–≤—Å–µ–≥–¥–∞', 'success');
}

async function saveDataAndRender() {
    if (currentUser) {
        localStorage.setItem('activistFilters', JSON.stringify({
            search: searchInput.value,
            sortBy: sortBySelect.value,
            status: statusFilter.value,
            grade: gradeFilter.value
        }));
    }
    await saveToDB(activists);
    renderActivists();
}

function renderActivists() {
    const searchTerm = searchInput.value.toLowerCase();
    const sortBy = sortBySelect.value;
    const status = statusFilter.value;
    const grade = gradeFilter.value;
    const letter = getActiveLetter();

    let filtered = activists.filter(activist => {
        if (status === 'active' && activist.archived) return false;
        if (status === 'archived' && !activist.archived) return false;
        if (grade !== 'all') {
            const range = getGradeRange(activist.class);
            if (range !== grade) return false;
        }
        if (letter && (!activist.lastName || !activist.lastName.startsWith(letter))) return false;
        const fullName = `${activist.lastName} ${activist.firstName} ${activist.middleName}`.toLowerCase();
        return (
            fullName.includes(searchTerm) ||
            activist.class.toLowerCase().includes(searchTerm) ||
            activist.phone.toLowerCase().includes(searchTerm) ||
            activist.email.toLowerCase().includes(searchTerm) ||
            (activist.role && activist.role.toLowerCase().includes(searchTerm)) ||
            (activist.curator && activist.curator.toLowerCase().includes(searchTerm))
        );
    });

    filtered.sort((a, b) => {
        if (sortBy === 'name') {
            const nameA = `${a.lastName} ${a.firstName}`.toLowerCase();
            const nameB = `${b.lastName} ${b.firstName}`.toLowerCase();
            return nameA.localeCompare(nameB);
        } else if (sortBy === 'class') {
            return a.class.localeCompare(b.class);
        } else if (sortBy === 'dateAdded') {
            return new Date(b.dateAdded) - new Date(a.dateAdded);
        }
        return 0;
    });

    const groups = {};
    filtered.forEach(a => {
        const firstLetter = a.lastName ? a.lastName[0].toUpperCase() : '#';
        if (!groups[firstLetter]) groups[firstLetter] = [];
        groups[firstLetter].push(a);
    });

    if (filtered.length === 0) {
        activistsContainer.innerHTML = `
            <div class="empty-state">
                <h3>–ù–µ—Ç –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤</h3>
                <p>–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É</p>
            </div>
        `;
        return;
    }

    let html = '';
    Object.keys(groups).sort().forEach(letter => {
        html += `<h3 style="margin: 20px 0 10px; color: var(--primary-dark);">${letter}</h3>`;
        groups[letter].forEach(activist => {
            const fullName = escapeHtml(`${activist.lastName} ${activist.firstName} ${activist.middleName}`);
            const roleBadge = activist.role ? `<span class="badge">${escapeHtml(activist.role)}</span>` : '';
            const statusClass = activist.archived ? 'archived' : '';
            const statusText = activist.archived ?
                '<span class="archived-status">–í –∞—Ä—Ö–∏–≤–µ</span>' :
                `<span class="${activist.registered ? 'registered' : 'not-registered'}">
                    ${activist.registered ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'}
                 </span>`;

            html += `
                <div class="activist-card ${statusClass}" id="card-${activist.id}">
                    <div class="activist-header">
                        <div class="activist-name">
                            ${fullName}
                            ${roleBadge}
                        </div>
                        <div class="registration-status">
                            ${statusText}
                            ${currentUser ? `
                                <button class="action-btn edit-btn" onclick="editActivist(${activist.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                                ${!activist.archived ?
                                    `<button class="action-btn archive-btn" onclick="archiveActivist(${activist.id})">–ê—Ä—Ö–∏–≤</button>` :
                                    `<button class="action-btn" onclick="deleteActivist(${activist.id})">–£–¥–∞–ª–∏—Ç—å</button>`
                                }
                            ` : ''}
                        </div>
                    </div>
                    <div class="activist-details">
                        <div class="detail-item">
                            <span class="detail-label">–ö–ª–∞—Å—Å</span>
                            <span class="detail-value">${escapeHtml(activist.class)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                            <span class="detail-value">${escapeHtml(activist.phone)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email</span>
                            <span class="detail-value">${escapeHtml(activist.email)}</span>
                        </div>
                        ${activist.curator ? `
                        <div class="detail-item">
                            <span class="detail-label">–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</span>
                            <span class="detail-value">${escapeHtml(activist.curator)}</span>
                        </div>` : ''}
                        <div class="detail-item">
                            <span class="detail-label">–î–æ–±–∞–≤–ª–µ–Ω</span>
                            <span class="detail-value">${formatDate(activist.dateAdded)}</span>
                        </div>
                    </div>
                </div>
            `;
        });
    });

    activistsContainer.innerHTML = html;
}

// Expose functions globally for onclick
window.editActivist = editActivist;
window.archiveActivist = archiveActivist;
window.deleteActivist = deleteActivist;

// Start app
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
