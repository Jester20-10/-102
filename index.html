<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ê–∫—Ç–∏–≤–∏—Å—Ç—ã –®–∫–æ–ª—ã</title>
<!-- SheetJS for Excel support -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<style>
:root {
--primary: #2563eb;
--primary-dark: #1d4ed8;
--secondary: #f9fafb;
--text: #1f2937;
--text-light: #6b7280;
--border: #e5e7eb;
--success: #10b981;
--warning: #f59e0b;
--danger: #ef4444;
--archive: #6b7280;
--card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body {
background-color: #f3f4f6;
color: var(--text);
line-height: 1.6;
}
.container {
max-width: 1200px;
margin: 0 auto;
padding: 20px;
}
header {
background: linear-gradient(135deg, var(--primary), var(--primary-dark));
color: white;
padding: 20px 0;
margin-bottom: 30px;
border-radius: 0 0 12px 12px;
box-shadow: var(--card-shadow);
}
.header-content {
display: flex;
justify-content: space-between;
align-items: center;
padding: 0 20px;
}
.logo {
font-size: 24px;
font-weight: bold;
}
.auth-section {
display: flex;
gap: 15px;
align-items: center;
}
.user-info {
display: flex;
align-items: center;
gap: 10px;
}
.logout-btn {
background: rgba(255, 255, 255, 0.2);
border: none;
color: white;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
transition: background 0.2s;
}
.logout-btn:hover {
background: rgba(255, 255, 255, 0.3);
}
.main-content {
display: grid;
grid-template-columns: 1fr 380px;
gap: 30px;
}
@media (max-width: 900px) {
.main-content {
grid-template-columns: 1fr;
}
}
.activists-list {
background: white;
border-radius: 12px;
padding: 25px;
box-shadow: var(--card-shadow);
}
.section-title {
font-size: 22px;
margin-bottom: 20px;
padding-bottom: 10px;
border-bottom: 2px solid var(--border);
color: var(--primary-dark);
display: flex;
justify-content: space-between;
align-items: center;
}
.section-actions {
display: flex;
gap: 10px;
}
.section-actions button {
background: var(--primary);
color: white;
border: none;
padding: 6px 12px;
border-radius: 6px;
font-size: 14px;
cursor: pointer;
}
.filters {
display: flex;
gap: 12px;
margin-bottom: 20px;
flex-wrap: wrap;
}
.filter-group {
flex: 1;
min-width: 150px;
}
.filter-label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: var(--text-light);
font-size: 13px;
}
.filter-input, .filter-select {
width: 100%;
padding: 10px 12px;
border: 1px solid var(--border);
border-radius: 8px;
font-size: 14px;
}
.alphabet-filter {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin-top: 10px;
margin-bottom: 15px;
}
.alphabet-btn {
width: 32px;
height: 32px;
border: 1px solid var(--border);
background: white;
border-radius: 6px;
font-weight: 600;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
}
.alphabet-btn.active {
background: var(--primary);
color: white;
border-color: var(--primary);
}
.activist-card {
background: var(--secondary);
border: 1px solid var(--border);
border-radius: 10px;
padding: 20px;
margin-bottom: 15px;
transition: transform 0.2s, box-shadow 0.2s;
position: relative;
opacity: 1;
}
.activist-card.archived {
opacity: 0.6;
border-left: 4px solid var(--archive);
}
.activist-card:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.1);
}
.action-btn {
background: var(--danger);
color: white;
border: none;
padding: 4px 10px;
border-radius: 20px;
cursor: pointer;
font-size: 12px;
font-weight: 600;
margin-left: 8px;
opacity: 0;
transition: opacity 0.2s;
}
.activist-card:hover .action-btn {
opacity: 1;
}
.edit-btn {
background: var(--warning);
}
.archive-btn {
background: var(--archive);
}
.registration-status {
display: inline-flex;
align-items: center;
gap: 8px;
}
.activist-header {
display: flex;
justify-content: space-between;
margin-bottom: 12px;
align-items: flex-start;
}
.activist-name {
font-size: 18px;
font-weight: 700;
color: var(--primary-dark);
display: flex;
align-items: center;
gap: 10px;
}
.badge {
background: var(--primary);
color: white;
padding: 2px 8px;
border-radius: 12px;
font-size: 12px;
font-weight: 600;
}
.activist-details {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
gap: 12px;
}
.detail-item {
display: flex;
flex-direction: column;
}
.detail-label {
font-size: 12px;
color: var(--text-light);
margin-bottom: 4px;
}
.detail-value {
font-weight: 600;
}
.registered {
background: rgba(16, 185, 129, 0.15);
color: var(--success);
padding: 4px 10px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
}
.not-registered {
background: rgba(239, 68, 68, 0.15);
color: var(--danger);
padding: 4px 10px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
}
.archived-status {
background: rgba(107, 114, 128, 0.15);
color: var(--archive);
padding: 4px 10px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
}
.form-section {
background: white;
border-radius: 12px;
padding: 25px;
box-shadow: var(--card-shadow);
height: fit-content;
}
.form-group {
margin-bottom: 20px;
}
.form-label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: var(--text);
}
.form-input, .form-select, .form-textarea {
width: 100%;
padding: 12px;
border: 1px solid var(--border);
border-radius: 8px;
font-size: 14px;
}
.form-textarea {
min-height: 80px;
resize: vertical;
}
.form-checkbox {
display: flex;
align-items: center;
gap: 10px;
margin-top: 8px;
}
.submit-btn, .import-export-btn {
background: var(--primary);
color: white;
border: none;
padding: 12px 24px;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
width: 100%;
transition: background 0.2s;
margin-top: 10px;
}
.submit-btn:hover, .import-export-btn:hover {
background: var(--primary-dark);
}
.submit-btn:disabled {
background: var(--text-light);
cursor: not-allowed;
}
.message {
padding: 12px;
border-radius: 8px;
margin-bottom: 20px;
text-align: center;
font-weight: 600;
}
.error {
background: rgba(239, 68, 68, 0.15);
color: var(--danger);
border: 1px solid var(--danger);
}
.success {
background: rgba(16, 185, 129, 0.15);
color: var(--success);
border: 1px solid var(--success);
}
.login-form {
background: white;
border-radius: 12px;
padding: 30px;
box-shadow: var(--card-shadow);
max-width: 400px;
margin: 50px auto;
}
.login-title {
text-align: center;
margin-bottom: 25px;
color: var(--primary-dark);
font-size: 24px;
}
.hidden {
display: none;
}
.empty-state {
text-align: center;
padding: 40px 20px;
color: var(--text-light);
}
.empty-state h3 {
margin-bottom: 10px;
color: var(--text);
}
.excel-drop-area {
border: 2px dashed var(--border);
border-radius: 8px;
padding: 20px;
text-align: center;
margin-top: 15px;
background: var(--secondary);
transition: border-color 0.2s;
}
.excel-drop-area.dragover {
border-color: var(--primary);
background: rgba(37, 99, 235, 0.05);
}
#file-input {
display: none;
}
.sync-status {
display: inline-flex;
align-items: center;
gap: 6px;
font-size: 12px;
color: var(--text-light);
}
.sync-dot {
width: 8px;
height: 8px;
border-radius: 50%;
background: var(--success);
animation: pulse 2s infinite;
}
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}
.loading-spinner {
display: inline-block;
width: 16px;
height: 16px;
border: 2px solid rgba(255,255,255,0.3);
border-radius: 50%;
border-top-color: #fff;
animation: spin 1s ease-in-out infinite;
margin-right: 8px;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div id="app">
<!-- Login Screen -->
<div id="login-screen" class="container">
<div class="login-form">
<h2 class="login-title">–í—Ö–æ–¥ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤</h2>
<div id="login-message" class="message hidden"></div>
<div class="form-group">
<label for="username" class="form-label">–õ–æ–≥–∏–Ω</label>
<select id="username" class="form-select">
<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</option>
<option value="predsedatel">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å —Å–æ–≤–µ—Ç–∞ –æ–±—É—á–∞—é—â–∏—Ö—Å—è</option>
<option value="sovetnik">–°–æ–≤–µ—Ç–Ω–∏–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</option>
<option value="sekretar">–°–µ–∫—Ä–µ—Ç–∞—Ä—å</option>
</select>
</div>
<div class="form-group">
<label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="password" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
</div>
<button id="login-btn" class="submit-btn">–í–æ–π—Ç–∏</button>
</div>
</div>
<!-- Main App -->
<div id="main-app" class="container hidden">
<header>
<div class="header-content">
<div class="logo">–ê–∫—Ç–∏–≤–∏—Å—Ç—ã –®–∫–æ–ª—ã</div>
<div class="auth-section">
<div class="user-info">
<span id="current-user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
<span class="sync-status"><span class="sync-dot"></span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span>
</div>
<button id="logout-btn" class="logout-btn">–í—ã–π—Ç–∏</button>
</div>
</div>
</header>
<div class="main-content">
<div class="activists-list">
<div class="section-title">
–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤
<div class="section-actions">
<button id="reset-filters-btn">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
<button id="export-btn">–≠–∫—Å–ø–æ—Ä—Ç Excel</button>
</div>
</div>
<div class="filters">
<div class="filter-group">
<label class="filter-label">–ü–æ–∏—Å–∫</label>
<input type="text" id="search-input" class="filter-input" placeholder="–§–ò–û, –∫–ª–∞—Å—Å, email...">
</div>
<div class="filter-group">
<label class="filter-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
<select id="sort-by" class="filter-select">
<option value="name">–ò–º–µ–Ω–∏</option>
<option value="class">–ö–ª–∞—Å—Å—É</option>
<option value="dateAdded">–î–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">–°—Ç–∞—Ç—É—Å</label>
<select id="status-filter" class="filter-select">
<option value="all">–í—Å–µ</option>
<option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
<option value="archived">–ê—Ä—Ö–∏–≤</option>
</select>
</div>
<div class="filter-group">
<label class="filter-label">–ì–æ–¥ –æ–±—É—á–µ–Ω–∏—è</label>
<select id="grade-filter" class="filter-select">
<option value="all">–í—Å–µ</option>
<option value="5-7">5‚Äì7 –∫–ª–∞—Å—Å—ã</option>
<option value="8-9">8‚Äì9 –∫–ª–∞—Å—Å—ã</option>
<option value="10-11">10‚Äì11 –∫–ª–∞—Å—Å—ã</option>
</select>
</div>
</div>
<div class="alphabet-filter" id="alphabet-filter">
<!-- Generated by JS -->
</div>
<div id="activists-container">
<!-- Activists will be rendered here -->
</div>
</div>
<div class="form-section">
<h2 class="section-title" id="form-title">–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞</h2>
<div id="form-message" class="message hidden"></div>
<form id="activist-form">
<input type="hidden" id="edit-id">
<div class="form-group">
<label for="first-name" class="form-label">–ò–º—è *</label>
<input type="text" id="first-name" class="form-input" required>
</div>
<div class="form-group">
<label for="last-name" class="form-label">–§–∞–º–∏–ª–∏—è *</label>
<input type="text" id="last-name" class="form-input" required>
</div>
<div class="form-group">
<label for="middle-name" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
<input type="text" id="middle-name" class="form-input">
</div>
<div class="form-group">
<label for="class" class="form-label">–ö–ª–∞—Å—Å *</label>
<select id="class" class="form-select" required>
<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
<option value="5–ê">5–ê</option>
<option value="5–ë">5–ë</option>
<option value="5–í">5–í</option>
<option value="5–ì">5–ì</option>
<option value="5–î">5–î</option>
<option value="5–ï">5–ï</option>
<option value="5–ú">5–ú</option>
<option value="6–ê">6–ê</option>
<option value="6–ë">6–ë</option>
<option value="6–í">6–í</option>
<option value="6–ì">6–ì</option>
<option value="6–î">6–î</option>
<option value="6–ï">6–ï</option>
<option value="7–ê">7–ê</option>
<option value="7–ë">7–ë</option>
<option value="7–í">7–í</option>
<option value="7–ì">7–ì</option>
<option value="7–î">7–î</option>
<option value="7–ï">7–ï</option>
<option value="8–ê">8–ê</option>
<option value="8–ë">8–ë</option>
<option value="8–í">8–í</option>
<option value="8–ì">8–ì</option>
<option value="8–î">8–î</option>
<option value="8–ï">8–ï</option>
<option value="9–ê">9–ê</option>
<option value="9–ë">9–ë</option>
<option value="9–í">9–í</option>
<option value="9–ì">9–ì</option>
<option value="9–î">9–î</option>
<option value="9–ï">9–ï</option>
<option value="10–ê">10–ê</option>
<option value="10–ë">10–ë</option>
<option value="11–ê">11–ê</option>
<option value="11–ë">11–ë</option>
</select>
</div>
<div class="form-group">
<label for="role" class="form-label">–†–æ–ª—å / –î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
<input type="text" id="role" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –°–û">
</div>
<div class="form-group">
<label for="curator" class="form-label">–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</label>
<input type="text" id="curator" class="form-input">
</div>
<div class="form-group">
<label for="phone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *</label>
<input type="tel" id="phone" class="form-input" required>
</div>
<div class="form-group">
<label for="email" class="form-label">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ *</label>
<input type="email" id="email" class="form-input" required>
</div>
<div class="form-group">
<label class="form-label">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –î–≤–∏–∂–µ–Ω–∏–∏ –ü–µ—Ä–≤—ã—Ö</label>
<div class="form-checkbox">
<input type="checkbox" id="registered">
<label for="registered">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω(–∞) –Ω–∞ —Å–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–µ—Ä–≤—ã—Ö</label>
</div>
</div>
<button type="submit" class="submit-btn" id="form-submit-btn">–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞</button>
</form>
<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
<h3 style="margin-bottom: 15px; font-size: 18px;">–ò–º–ø–æ—Ä—Ç –∏–∑ Excel</h3>
<div class="excel-drop-area" id="drop-area">
<p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª Excel (.xlsx) —Å—é–¥–∞<br>–∏–ª–∏</p>
<button type="button" class="import-export-btn" id="browse-btn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
<input type="file" id="file-input" accept=".xlsx, .xls">
</div>
<p style="font-size: 12px; color: var(--text-light); margin-top: 10px;">
–û–∂–∏–¥–∞–µ–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã: –§–∞–º–∏–ª–∏—è, –ò–º—è, –û—Ç—á–µ—Å—Ç–≤–æ, –ö–ª–∞—Å—Å, –¢–µ–ª–µ—Ñ–æ–Ω, Email, –†–æ–ª—å, –ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å, –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
</p>
</div>
</div>
</div>
</div>
</div>

<script type="module">
// –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyD-6FhGeq3uC06NwQC_S6t1cdjwcREe_OE",
  authDomain: "schoolactivists-856eb.firebaseapp.com",
  projectId: "schoolactivists-856eb",
  storageBucket: "schoolactivists-856eb.firebasestorage.app",
  messagingSenderId: "606944183235",
  appId: "1:606944183235:web:f682cf8b5da30fa71db376",
  measurementId: "G-2N86E0NVJC"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let activists = [];
let isDataLoaded = false;
let isSubmitting = false;

const editorAccounts = {
  predsedatel: { password: "chairman", name: "–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å —Å–æ–≤–µ—Ç–∞ –æ–±—É—á–∞—é—â–∏—Ö—Å—è" },
  sovetnik: { password: "advisor", name: "–°–æ–≤–µ—Ç–Ω–∏–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞" },
  sekretar: { password: "secretary", name: "–°–µ–∫—Ä–µ—Ç–∞—Ä—å" }
};
let currentUser = null;

// DOM Elements
const loginScreen = document.getElementById('login-screen');
const mainApp = document.getElementById('main-app');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const usernameSelect = document.getElementById('username');
const passwordInput = document.getElementById('password');
const loginMessage = document.getElementById('login-message');
const currentUserSpan = document.getElementById('current-user');
const activistForm = document.getElementById('activist-form');
const formMessage = document.getElementById('form-message');
const searchInput = document.getElementById('search-input');
const sortBySelect = document.getElementById('sort-by');
const statusFilter = document.getElementById('status-filter');
const gradeFilter = document.getElementById('grade-filter');
const activistsContainer = document.getElementById('activists-container');
const exportBtn = document.getElementById('export-btn');
const formTitle = document.getElementById('form-title');
const formSubmitBtn = document.getElementById('form-submit-btn');
const editIdInput = document.getElementById('edit-id');
const alphabetFilter = document.getElementById('alphabet-filter');
const resetFiltersBtn = document.getElementById('reset-filters-btn');
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const browseBtn = document.getElementById('browse-btn');

// --- –§–£–ù–ö–¶–ò–ò FIREBASE ---

function subscribeToData() {
  const activistsRef = ref(db, 'activists');
  onValue(activistsRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      activists = Object.keys(data).map(key => ({
        id: key,
        ...data[key]
      }));
    } else {
      activists = [];
    }
    isDataLoaded = true;
    console.log('üìä –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', activists.length, '–∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤');
    renderActivists();
  }, (error) => {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", error);
    showFormMessage('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message, 'error');
  });
}

// --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getGradeRange(className) {
  if (!className) return null;
  const num = parseInt(className);
  if (num >= 5 && num <= 7) return '5-7';
  if (num >= 8 && num <= 9) return '8-9';
  if (num >= 10 && num <= 11) return '10-11';
  return null;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('ru-RU');
}

function exportToExcel() {
  if (activists.length === 0) {
    alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
    return;
  }
  if (typeof XLSX === 'undefined') {
    alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ SheetJS –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.');
    return;
  }
  
  const wsData = [
    ['–§–∞–º–∏–ª–∏—è', '–ò–º—è', '–û—Ç—á–µ—Å—Ç–≤–æ', '–ö–ª–∞—Å—Å', '–¢–µ–ª–µ—Ñ–æ–Ω', 'Email', '–†–æ–ª—å', '–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å', '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è']
  ];
  activists.forEach(a => {
    wsData.push([
      a.lastName,
      a.firstName,
      a.middleName || '',
      a.class,
      a.phone,
      a.email,
      a.role || '',
      a.curator || '',
      a.registered ? '–î–∞' : '–ù–µ—Ç',
      a.archived ? '–ê—Ä—Ö–∏–≤' : '–ê–∫—Ç–∏–≤–µ–Ω',
      formatDate(a.dateAdded)
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–ê–∫—Ç–∏–≤–∏—Å—Ç—ã');
  XLSX.writeFile(wb, `–∞–∫—Ç–∏–≤–∏—Å—Ç—ã_—à–∫–æ–ª—ã_${new Date().toISOString().slice(0,10)}.xlsx`);
}

function parseExcelFile(data) {
  const workbook = XLSX.read(data, { type: 'array' });
  const firstSheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[firstSheetName];
  const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
  if (jsonData.length < 2) return [];
  const headers = jsonData[0].map(h => h.toString().trim());
  const result = [];
  for (let i = 1; i < jsonData.length; i++) {
    const row = jsonData[i];
    if (!row || row.length === 0) continue;
    const obj = {};
    for (let j = 0; j < headers.length && j < row.length; j++) {
      obj[headers[j]] = row[j] != null ? row[j].toString().trim() : '';
    }
    if (!obj['–§–∞–º–∏–ª–∏—è'] || !obj['–ò–º—è'] || !obj['–ö–ª–∞—Å—Å'] || !obj['–¢–µ–ª–µ—Ñ–æ–Ω'] || !obj['Email']) {
      continue;
    }
    result.push({
      lastName: obj['–§–∞–º–∏–ª–∏—è'] || '',
      firstName: obj['–ò–º—è'] || '',
      middleName: obj['–û—Ç—á–µ—Å—Ç–≤–æ'] || '',
      class: obj['–ö–ª–∞—Å—Å'] || '',
      phone: obj['–¢–µ–ª–µ—Ñ–æ–Ω'] || '',
      email: obj['Email'] || '',
      role: obj['–†–æ–ª—å'] || '',
      curator: obj['–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'] || '',
      registered: obj['–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'] === '–î–∞',
      archived: obj['–°—Ç–∞—Ç—É—Å'] === '–ê—Ä—Ö–∏–≤',
      dateAdded: new Date().toISOString()
    });
  }
  return result;
}

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const newActivists = parseExcelFile(data);
      if (newActivists.length === 0) {
        showFormMessage('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ', 'error');
        return;
      }
      
      const updates = {};
      newActivists.forEach(act => {
        const newKey = push(ref(db, 'activists')).key;
        updates['/activists/' + newKey] = act;
      });
      
      update(ref(db), updates)
        .then(() => showFormMessage(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${newActivists.length} –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤`, 'success'))
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', err);
          showFormMessage('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message, 'error');
        });
        
    } catch (err) {
      console.error(err);
      showFormMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞', 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

function restoreSession() {
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser) {
    try {
      const user = JSON.parse(savedUser);
      if (editorAccounts[user.username]) {
        currentUser = user;
        loginScreen.classList.add('hidden');
        mainApp.classList.remove('hidden');
        currentUserSpan.textContent = user.name;
        subscribeToData();
        return true;
      }
    } catch (e) {
      console.warn('Invalid session');
    }
  }
  return false;
}

async function init() {
  loginBtn.addEventListener('click', handleLogin);
  logoutBtn.addEventListener('click', handleLogout);
  activistForm.addEventListener('submit', handleFormSubmit);
  searchInput.addEventListener('input', renderActivists);
  sortBySelect.addEventListener('change', renderActivists);
  statusFilter.addEventListener('change', renderActivists);
  gradeFilter.addEventListener('change', renderActivists);
  exportBtn.addEventListener('click', exportToExcel);
  resetFiltersBtn.addEventListener('click', resetFilters);
  browseBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    if (e.target.files[0]) handleFile(e.target.files[0]);
  });

  dropArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropArea.classList.add('dragover');
  });
  dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
  dropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  });

  renderAlphabetFilter();
  
  const sessionRestored = restoreSession();
  if (!sessionRestored) {
    loginScreen.classList.remove('hidden');
    mainApp.classList.add('hidden');
  }
}

function renderAlphabetFilter() {
  const letters = '–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–≠–Æ–Ø';
  alphabetFilter.innerHTML = letters.split('').map(letter =>
    `<button class="alphabet-btn" data-letter="${letter}">${letter}</button>`
  ).join('');
  alphabetFilter.querySelectorAll('.alphabet-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      alphabetFilter.querySelectorAll('.alphabet-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderActivists();
    });
  });
}

function getActiveLetter() {
  const active = alphabetFilter.querySelector('.alphabet-btn.active');
  return active ? active.dataset.letter : null;
}

function resetFilters() {
  searchInput.value = '';
  sortBySelect.value = 'name';
  statusFilter.value = 'all';
  gradeFilter.value = 'all';
  alphabetFilter.querySelectorAll('.alphabet-btn').forEach(b => b.classList.remove('active'));
  renderActivists();
}

function handleLogin(e) {
  e.preventDefault();
  const username = usernameSelect.value;
  const password = passwordInput.value;
  if (!username || !password) {
    showLoginMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
    return;
  }
  if (editorAccounts[username] && editorAccounts[username].password === password) {
    currentUser = { username, name: editorAccounts[username].name };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    loginScreen.classList.add('hidden');
    mainApp.classList.remove('hidden');
    currentUserSpan.textContent = currentUser.name;
    passwordInput.value = '';
    subscribeToData();
  } else {
    showLoginMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
  }
}

function handleLogout() {
  currentUser = null;
  localStorage.removeItem('currentUser');
  mainApp.classList.add('hidden');
  loginScreen.classList.remove('hidden');
  usernameSelect.value = '';
  passwordInput.value = '';
  loginMessage.classList.add('hidden');
  activists = [];
  renderActivists();
}

function showLoginMessage(msg, type) {
  loginMessage.textContent = msg;
  loginMessage.className = `message ${type}`;
  loginMessage.classList.remove('hidden');
  setTimeout(() => loginMessage.classList.add('hidden'), 3000);
}

function showFormMessage(msg, type) {
  formMessage.textContent = msg;
  formMessage.className = `message ${type}`;
  formMessage.classList.remove('hidden');
  setTimeout(() => formMessage.classList.add('hidden'), 3000);
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ê–ö–¢–ò–í–ò–°–¢–ê
function handleFormSubmit(e) {
  e.preventDefault();
  
  // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
  if (isSubmitting) {
    console.log('‚ö†Ô∏è –§–æ—Ä–º–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è');
    return;
  }
  
  console.log('üìù –ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã');
  
  // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
  const formData = {
    firstName: document.getElementById('first-name').value.trim(),
    lastName: document.getElementById('last-name').value.trim(),
    middleName: document.getElementById('middle-name').value.trim(),
    class: document.getElementById('class').value,
    role: document.getElementById('role').value.trim(),
    curator: document.getElementById('curator').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim(),
    registered: document.getElementById('registered').checked
  };

  console.log('üìã –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', formData);

  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!formData.firstName || !formData.lastName || !formData.class || !formData.phone || !formData.email) {
    console.log('‚ùå –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
    showFormMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–ò–º—è, –§–∞–º–∏–ª–∏—è, –ö–ª–∞—Å—Å, –¢–µ–ª–µ—Ñ–æ–Ω, Email)', 'error');
    return;
  }

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
  isSubmitting = true;
  formSubmitBtn.disabled = true;
  formSubmitBtn.innerHTML = '<span class="loading-spinner"></span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

  const editId = editIdInput.value;
  console.log('üîç ID —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', editId);

  if (editId) {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ
    console.log('‚úèÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Å—Ç–∞:', editId);
    update(ref(db, 'activists/' + editId), formData)
      .then(() => {
        console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
        editIdInput.value = '';
        formTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞';
        formSubmitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞';
        activistForm.reset();
        showFormMessage('–ê–∫—Ç–∏–≤–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
      })
      .catch(err => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err);
        showFormMessage('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + err.message, 'error');
      })
      .finally(() => {
        isSubmitting = false;
        formSubmitBtn.disabled = false;
      });
  } else {
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
    console.log('‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∏—Å—Ç–∞');
    const newActivist = {
      ...formData,
      archived: false,
      dateAdded: new Date().toISOString()
    };
    
    push(ref(db, 'activists'), newActivist)
      .then(() => {
        console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
        activistForm.reset();
        showFormMessage('–ê–∫—Ç–∏–≤–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
      })
      .catch(err => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', err);
        showFormMessage('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + err.message, 'error');
      })
      .finally(() => {
        isSubmitting = false;
        formSubmitBtn.disabled = false;
        formSubmitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞';
      });
  }
}

function archiveActivist(activistId) {
  console.log('üì¶ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è:', activistId);
  update(ref(db, 'activists/' + activistId), { archived: true })
    .then(() => showFormMessage('–ü–µ—Ä–µ–º–µ—â—ë–Ω –≤ –∞—Ä—Ö–∏–≤', 'success'))
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏:', err);
      alert(err.message);
    });
}

function editActivist(activistId) {
  console.log('‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:', activistId);
  const activist = activists.find(a => a.id === activistId);
  if (!activist) {
    console.error('–ê–∫—Ç–∏–≤–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:', activistId);
    return;
  }
  document.getElementById('first-name').value = activist.firstName;
  document.getElementById('last-name').value = activist.lastName;
  document.getElementById('middle-name').value = activist.middleName || '';
  document.getElementById('class').value = activist.class;
  document.getElementById('role').value = activist.role || '';
  document.getElementById('curator').value = activist.curator || '';
  document.getElementById('phone').value = activist.phone;
  document.getElementById('email').value = activist.email;
  document.getElementById('registered').checked = activist.registered;
  editIdInput.value = activist.id;
  formTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–∏—Å—Ç–∞';
  formSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
  window.scrollTo(0, 0);
}

function deleteActivist(activistId) {
  if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
  
  console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ:', activistId);
  remove(ref(db, 'activists/' + activistId))
    .then(() => showFormMessage('–£–¥–∞–ª—ë–Ω –Ω–∞–≤—Å–µ–≥–¥–∞', 'success'))
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
      alert(err.message);
    });
}

function renderActivists() {
  if (!isDataLoaded && !currentUser) return;

  const searchTerm = searchInput.value.toLowerCase();
  const sortBy = sortBySelect.value;
  const status = statusFilter.value;
  const grade = gradeFilter.value;
  const letter = getActiveLetter();

  let filtered = activists.filter(activist => {
    if (status === 'active' && activist.archived) return false;
    if (status === 'archived' && !activist.archived) return false;
    if (grade !== 'all') {
      const range = getGradeRange(activist.class);
      if (range !== grade) return false;
    }
    if (letter && (!activist.lastName || !activist.lastName.startsWith(letter))) return false;
    
    const fullName = `${activist.lastName} ${activist.firstName} ${activist.middleName}`.toLowerCase();
    return (
      fullName.includes(searchTerm) ||
      activist.class.toLowerCase().includes(searchTerm) ||
      activist.phone.toLowerCase().includes(searchTerm) ||
      activist.email.toLowerCase().includes(searchTerm) ||
      (activist.role && activist.role.toLowerCase().includes(searchTerm)) ||
      (activist.curator && activist.curator.toLowerCase().includes(searchTerm))
    );
  });

  filtered.sort((a, b) => {
    if (sortBy === 'name') {
      return `${a.lastName} ${a.firstName}`.localeCompare(`${b.lastName} ${b.firstName}`);
    } else if (sortBy === 'class') {
      return a.class.localeCompare(b.class);
    } else if (sortBy === 'dateAdded') {
      return new Date(b.dateAdded) - new Date(a.dateAdded);
    }
    return 0;
  });

  const groups = {};
  filtered.forEach(a => {
    const firstLetter = a.lastName ? a.lastName[0].toUpperCase() : '#';
    if (!groups[firstLetter]) groups[firstLetter] = [];
    groups[firstLetter].push(a);
  });

  if (filtered.length === 0) {
    activistsContainer.innerHTML = `<div class="empty-state"><h3>–ù–µ—Ç –∞–∫—Ç–∏–≤–∏—Å—Ç–æ–≤</h3><p>–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p></div>`;
    return;
  }

  let html = '';
  Object.keys(groups).sort().forEach(letter => {
    html += `<h3 style="margin: 20px 0 10px; color: var(--primary-dark);">${letter}</h3>`;
    groups[letter].forEach(activist => {
      const fullName = escapeHtml(`${activist.lastName} ${activist.firstName} ${activist.middleName}`);
      const roleBadge = activist.role ? `<span class="badge">${escapeHtml(activist.role)}</span>` : '';
      const statusClass = activist.archived ? 'archived' : '';
      const statusText = activist.archived ?
        '<span class="archived-status">–í –∞—Ä—Ö–∏–≤–µ</span>' :
        `<span class="${activist.registered ? 'registered' : 'not-registered'}">${activist.registered ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'}</span>`;

      html += `
      <div class="activist-card ${statusClass}" id="card-${activist.id}">
        <div class="activist-header">
          <div class="activist-name">${fullName} ${roleBadge}</div>
          <div class="registration-status">
            ${statusText}
            ${currentUser ? `
              <button class="action-btn edit-btn" onclick="window.editActivist('${activist.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              ${!activist.archived ?
                `<button class="action-btn archive-btn" onclick="window.archiveActivist('${activist.id}')">–ê—Ä—Ö–∏–≤</button>` :
                `<button class="action-btn" onclick="window.deleteActivist('${activist.id}')">–£–¥–∞–ª–∏—Ç—å</button>`
              }
            ` : ''}
          </div>
        </div>
        <div class="activist-details">
          <div class="detail-item"><span class="detail-label">–ö–ª–∞—Å—Å</span><span class="detail-value">${escapeHtml(activist.class)}</span></div>
          <div class="detail-item"><span class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</span><span class="detail-value">${escapeHtml(activist.phone)}</span></div>
          <div class="detail-item"><span class="detail-label">Email</span><span class="detail-value">${escapeHtml(activist.email)}</span></div>
          ${activist.curator ? `<div class="detail-item"><span class="detail-label">–ö—É—Ä–∞—Ç–æ—Ä</span><span class="detail-value">${escapeHtml(activist.curator)}</span></div>` : ''}
          <div class="detail-item"><span class="detail-label">–î–æ–±–∞–≤–ª–µ–Ω</span><span class="detail-value">${formatDate(activist.dateAdded)}</span></div>
        </div>
      </div>`;
    });
  });
  activistsContainer.innerHTML = html;
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick
window.editActivist = editActivist;
window.archiveActivist = archiveActivist;
window.deleteActivist = deleteActivist;

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
